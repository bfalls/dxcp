name: Governance Tests

on:
  workflow_dispatch:

jobs:
  govtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Decide govtest mode
        id: mode
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${GOV_DXCP_API_BASE:-}" || -z "${GOV_DXCP_UI_BASE:-}" || -z "${GOV_AWS_REGION:-}" || -z "${GOV_CI_CLIENT_SECRET:-}" ]]; then
            echo "args=--dry-run" >> "$GITHUB_OUTPUT"
            echo "mode=DRY_RUN" >> "$GITHUB_OUTPUT"
          else
            echo "args=" >> "$GITHUB_OUTPUT"
            echo "mode=FULL" >> "$GITHUB_OUTPUT"
          fi

      - name: Run governance harness
        env:
          GOV_DXCP_UI_BASE: ${{ vars.GOV_DXCP_UI_BASE }}
          GOV_DXCP_API_BASE: ${{ vars.GOV_DXCP_API_BASE }}
          GOV_AWS_REGION: ${{ vars.GOV_AWS_REGION }}
          GOV_AUTH0_DOMAIN: ${{ vars.GOV_AUTH0_DOMAIN }}
          GOV_AUTH0_AUDIENCE: ${{ vars.GOV_AUTH0_AUDIENCE }}
          GOV_ADMIN_CLIENT_ID: ${{ secrets.GOV_ADMIN_CLIENT_ID }}
          GOV_ADMIN_CLIENT_SECRET: ${{ secrets.GOV_ADMIN_CLIENT_SECRET }}
          GOV_OWNER_CLIENT_ID: ${{ secrets.GOV_OWNER_CLIENT_ID }}
          GOV_OWNER_CLIENT_SECRET: ${{ secrets.GOV_OWNER_CLIENT_SECRET }}
          GOV_OBSERVER_CLIENT_ID: ${{ secrets.GOV_OBSERVER_CLIENT_ID }}
          GOV_OBSERVER_CLIENT_SECRET: ${{ secrets.GOV_OBSERVER_CLIENT_SECRET }}
          GOV_CI_CLIENT_ID: ${{ secrets.GOV_CI_CLIENT_ID }}
          GOV_CI_CLIENT_SECRET: ${{ secrets.GOV_CI_CLIENT_SECRET }}
        run: npm run govtest -- ${{ steps.mode.outputs.args }}

      - name: Summary
        run: |
          echo "Governance harness mode: ${{ steps.mode.outputs.mode }}" >> "$GITHUB_STEP_SUMMARY"
