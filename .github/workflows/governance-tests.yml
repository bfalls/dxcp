name: Governance Tests

on:
  workflow_dispatch:

jobs:
  govtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Decide govtest mode
        id: mode
        env:
          GOV_DXCP_UI_BASE: ${{ vars.GOV_DXCP_UI_BASE }}
          GOV_DXCP_API_BASE: ${{ vars.GOV_DXCP_API_BASE }}
          GOV_AWS_REGION: ${{ vars.GOV_AWS_REGION }}
          GOV_AUTH0_DOMAIN: ${{ vars.GOV_AUTH0_DOMAIN }}
          GOV_AUTH0_AUDIENCE: ${{ vars.GOV_AUTH0_AUDIENCE }}
          GOV_ADMIN_CLIENT_ID: ${{ secrets.GOV_ADMIN_CLIENT_ID }}
          GOV_ADMIN_CLIENT_SECRET: ${{ secrets.GOV_ADMIN_CLIENT_SECRET }}
          GOV_OWNER_CLIENT_ID: ${{ secrets.GOV_OWNER_CLIENT_ID }}
          GOV_OWNER_CLIENT_SECRET: ${{ secrets.GOV_OWNER_CLIENT_SECRET }}
          GOV_OBSERVER_CLIENT_ID: ${{ secrets.GOV_OBSERVER_CLIENT_ID }}
          GOV_OBSERVER_CLIENT_SECRET: ${{ secrets.GOV_OBSERVER_CLIENT_SECRET }}
          GOV_CI_CLIENT_ID: ${{ secrets.GOV_CI_CLIENT_ID }}
          GOV_CI_CLIENT_SECRET: ${{ secrets.GOV_CI_CLIENT_SECRET }}
        shell: bash
        run: |
          set -euo pipefail
          missing=()
          for key in \
            GOV_DXCP_UI_BASE GOV_DXCP_API_BASE GOV_AWS_REGION \
            GOV_AUTH0_DOMAIN GOV_AUTH0_AUDIENCE \
            GOV_ADMIN_CLIENT_ID GOV_ADMIN_CLIENT_SECRET \
            GOV_OWNER_CLIENT_ID GOV_OWNER_CLIENT_SECRET \
            GOV_OBSERVER_CLIENT_ID GOV_OBSERVER_CLIENT_SECRET \
            GOV_CI_CLIENT_ID GOV_CI_CLIENT_SECRET; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("$key")
            fi
          done

          if [[ "${#missing[@]}" -gt 0 ]]; then
            {
              printf 'missing_keys=%s\n' "${missing[*]}"
              echo "args=--dry-run"
              echo "mode=DRY_RUN"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "missing_keys="
              echo "args="
              echo "mode=FULL"
            } >> "$GITHUB_OUTPUT"
          fi

      - name: Run governance harness
        env:
          GOV_DXCP_UI_BASE: ${{ vars.GOV_DXCP_UI_BASE }}
          GOV_DXCP_API_BASE: ${{ vars.GOV_DXCP_API_BASE }}
          GOV_AWS_REGION: ${{ vars.GOV_AWS_REGION }}
          GOV_AUTH0_DOMAIN: ${{ vars.GOV_AUTH0_DOMAIN }}
          GOV_AUTH0_AUDIENCE: ${{ vars.GOV_AUTH0_AUDIENCE }}
          GOV_ADMIN_CLIENT_ID: ${{ secrets.GOV_ADMIN_CLIENT_ID }}
          GOV_ADMIN_CLIENT_SECRET: ${{ secrets.GOV_ADMIN_CLIENT_SECRET }}
          GOV_OWNER_CLIENT_ID: ${{ secrets.GOV_OWNER_CLIENT_ID }}
          GOV_OWNER_CLIENT_SECRET: ${{ secrets.GOV_OWNER_CLIENT_SECRET }}
          GOV_OBSERVER_CLIENT_ID: ${{ secrets.GOV_OBSERVER_CLIENT_ID }}
          GOV_OBSERVER_CLIENT_SECRET: ${{ secrets.GOV_OBSERVER_CLIENT_SECRET }}
          GOV_CI_CLIENT_ID: ${{ secrets.GOV_CI_CLIENT_ID }}
          GOV_CI_CLIENT_SECRET: ${{ secrets.GOV_CI_CLIENT_SECRET }}
        run: npm run govtest -- ${{ steps.mode.outputs.args }}

      - name: Summary
        run: |
          {
            echo "Governance harness mode: ${{ steps.mode.outputs.mode }}"
            if [[ -n "${{ steps.mode.outputs.missing_keys }}" ]]; then
              echo "Missing GOV_ keys: ${{ steps.mode.outputs.missing_keys }}"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
