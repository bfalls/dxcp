name: Governance Tests

on:
  workflow_dispatch:

jobs:
  govtest:
    runs-on: ubuntu-latest
    outputs:
      run_version: ${{ steps.extract.outputs.run_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: npm install --no-audit --no-fund

      - name: Install UI dependencies
        run: cd ui && npm install --no-audit --no-fund

      - name: Install Playwright browser (Chromium)
        run: cd ui && npx playwright install --with-deps chromium

      - name: Install dxcp-api Python dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r dxcp-api/requirements.txt
          python -m pip install -r requirements-dev.txt

      - name: Run governance contract unit subset
        run: python dxcp-api/scripts/governance_contract_unit.py

      - name: Run governance runtime harness (strict)
        env:
          GOV_DXCP_UI_BASE: ${{ vars.GOV_DXCP_UI_BASE }}
          GOV_DXCP_API_BASE: ${{ vars.GOV_DXCP_API_BASE }}
          GOV_AWS_REGION: ${{ vars.GOV_AWS_REGION }}
          GOV_AUTH0_DOMAIN: ${{ vars.GOV_AUTH0_DOMAIN }}
          GOV_AUTH0_AUDIENCE: ${{ vars.GOV_AUTH0_AUDIENCE }}
          GOV_DXCP_UI_CLIENT_ID: ${{ secrets.GOV_DXCP_UI_CLIENT_ID }}
          GOV_ADMIN_USERNAME: ${{ secrets.GOV_ADMIN_USERNAME }}
          GOV_ADMIN_PASSWORD: ${{ secrets.GOV_ADMIN_PASSWORD }}
          GOV_OWNER_USERNAME: ${{ secrets.GOV_OWNER_USERNAME }}
          GOV_OWNER_PASSWORD: ${{ secrets.GOV_OWNER_PASSWORD }}
          GOV_OBSERVER_USERNAME: ${{ secrets.GOV_OBSERVER_USERNAME }}
          GOV_OBSERVER_PASSWORD: ${{ secrets.GOV_OBSERVER_PASSWORD }}
          GOV_NON_MEMBER_OWNER_USERNAME: ${{ secrets.GOV_NON_MEMBER_OWNER_USERNAME }}
          GOV_NON_MEMBER_OWNER_PASSWORD: ${{ secrets.GOV_NON_MEMBER_OWNER_PASSWORD }}
          GOV_CI_CLIENT_ID: ${{ secrets.GOV_CI_CLIENT_ID }}
          GOV_CI_CLIENT_SECRET: ${{ secrets.GOV_CI_CLIENT_SECRET }}
          CI: "true"
        shell: bash
        run: |
          set -euo pipefail
          npm run govtest -- --strict | tee govtest-output.log

      - name: Extract run version
        id: extract
        shell: bash
        run: |
          set -euo pipefail
          run_version="$(grep -E '^runVersion=' govtest-output.log | tail -n1 | cut -d'=' -f2- || true)"
          echo "run_version=${run_version}" >> "$GITHUB_OUTPUT"

      - name: Merge conformance snapshots
        id: merge
        shell: bash
        run: |
          set +e
          node --experimental-strip-types scripts/govtest/merge_conformance_snapshot.ts
          status=$?
          echo "status=$status" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload governance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: governance-conformance-artifacts
          if-no-files-found: warn
          path: |
            .govtest.contract.snapshot.json
            .dxcpapi.governance.snapshot.json
            .governance.conformance.snapshot.json
            .govtest.last-run.json

      - name: Summary
        if: always()
        run: |
          {
            if [[ -n "${{ steps.extract.outputs.run_version }}" ]]; then
              echo "GOV_RUN_VERSION: ${{ steps.extract.outputs.run_version }}"
            fi
            if [[ "${{ steps.merge.outputs.status }}" == "0" ]]; then
              echo "Unified governance conformance: PASS"
            else
              echo "Unified governance conformance: FAIL"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Enforce merged conformance PASS
        if: always()
        shell: bash
        run: |
          if [[ "${{ steps.merge.outputs.status }}" != "0" ]]; then
            echo "Merged governance conformance status is FAIL."
            exit 1
          fi
